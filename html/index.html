<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>BL√ÖHAJ finder</title>
		<link
			rel="icon"
			type="image/png"
			sizes="32x32"
			href="favicon-32x32.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="16x16"
			href="favicon-16x16.png"
		/>
		<meta name="msapplication-TileColor" content="#468293" />
		<!-- <meta name="msapplication-config" content="/assets/icons/browserconfig.xml"> -->
		<meta name="theme-color" content="#468293" />
		<meta name="description" content="Hourly BL√ÖHAJ finder map" />
		<meta property="og:url" content="https://blahaj.quest/" />
		<meta property="og:type" content="website" />
		<meta property="og:title" content="BL√ÖHAJ finder ü¶à" />
		<meta property="og:description" content="Hourly BL√ÖHAJ finder map" />
		<meta
			property="og:image"
			content="https://blahaj.quest/img/full-flipped.png"
		/>
		<meta property="twitter:url" content="https://blahaj.quest/" />
		<meta name="twitter:title" content="BL√ÖHAJ finder ü¶à" />
		<meta name="twitter:description" content="Hourly BL√ÖHAJ finder map" />
		<meta
			name="twitter:image"
			content="https://blahaj.quest/img/full-flipped.png"
		/>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap"
			rel="stylesheet"
		/>
		<link
			rel="stylesheet"
			href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
			integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
			crossorigin=""
		/>
		<script
			src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
			integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
			crossorigin=""
		></script>
		<script src="https://unpkg.com/heatmap.js@2.0.5/build/heatmap.js"></script>
		<script src="leaflet-heatmap.js"></script>
		<script async defer src="https://buttons.github.io/buttons.js"></script>
		<style>
			* {
				margin: 0;
			}

			body {
				overflow: hidden;
				font-family: "Noto Sans", sans-serif;
			}

			.leaflet-container {
				font-family: "Noto Sans", sans-serif;
			}

			.leaflet-popup-content-wrapper {
				border-radius: 999px;
			}

			#map {
				width: 100vw;
				height: calc(100vh - 48px);
			}

			.header {
				width: 100vw;
				height: 48px;
				display: flex;
				align-items: center;
				justify-content: flex-start;
				flex-direction: row;
				color: #fff;
				background-image: linear-gradient(
						0deg,
						rgba(29, 31, 33, 0.3),
						rgba(29, 31, 33, 0.3)
					),
					linear-gradient(0deg, #468293, #468293);
			}

			.icon {
				width: 128px;
				height: 48px;
				background-image: url("img/full-flipped.png");
				background-size: cover;
				background-position: 50% 60%;
			}

			.title {
				font-size: 1.6rem;
				margin-left: 16px;
				margin-top: -4px;
			}

			.title a {
				text-decoration: none;
				color: #fff;
			}
		</style>
	</head>
	<body>
		<div class="header">
			<div class="icon"></div>
			<h1 class="title">
				<a
					href="https://www.ikea.com/us/en/p/blahaj-soft-toy-shark-90373590/"
				>
					BL√ÖHAJ finder
				</a>
			</h1>
			<p style="margin-left: 32px">
				Last updated: <b id="updated">loading...</b>
				<span style="opacity: 0.6">(updates hourly)</span>
			</p>
			<p style="margin-left: 32px">
				<b><span id="total-stores"></span> stores</b> indexed
			</p>
			<div style="flex-grow: 1"></div>
			<a
				href="https://maki.cafe"
				style="color: #fff; text-decoration: none; margin-right: 16px"
			>
				Made by <b>Maki</b>
			</a>
			<span style="margin-right: 12px">
				<a
					class="github-button"
					href="https://github.com/makitsune/blahaj-finder"
					data-color-scheme="no-preference: light; light: light; dark: light;"
					data-size="large"
					data-show-count="true"
					aria-label="Star makitsune/blahaj-finder on GitHub"
				>
					Star
				</a>
			</span>
		</div>
		<div id="map"></div>
		<script>
			const zoomHeatRadiusMap = {
				0: 16,
				1: 12,
				2: 8,
				3: 4,
				4: 3,
				5: 2,
				6: 1,
				default: 0.5, // 7 or higher
			};

			const defaultZoom = 3;
			const map = L.map("map").setView(
				[30.826780904779774, -30.937500000000004],
				defaultZoom,
			);

			L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
				attribution:
					'&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>',
				maxZoom: 19,
			}).addTo(map);

			(async () => {
				const res = await fetch("blahaj.json?" + Date.now());
				const blahajData = await res.json();

				const updated = new Date(blahajData.updated);
				document.getElementById("updated").textContent =
					updated.toLocaleString();

				document.getElementById("total-stores").textContent =
					blahajData.data.length;

				const heatmapLayer = new HeatmapOverlay({
					radius: zoomHeatRadiusMap[defaultZoom],
					maxOpacity: 0.6,
					scaleRadius: true,
					useLocalExtrema: true,
					latField: "lat",
					lngField: "lng",
					valueField: "quantity",
				});
				heatmapLayer.setData({ data: blahajData.data });
				heatmapLayer.addTo(map);
				window.heatmapLayer = heatmapLayer;

				map.on("zoomend", e => {
					const zoom = e.target.getZoom();
					const radius =
						zoomHeatRadiusMap[zoom] ?? zoomHeatRadiusMap["default"];

					console.log(`zoom: ${zoom}, radius: ${radius}`);
					heatmapLayer.cfg.radius = radius;
					heatmapLayer._draw();
				});

				const iconSize = 48;
				const iconSettings = {
					// iconUrl: url,
					iconSize: [iconSize, iconSize],
					iconAnchor: [iconSize / 2, iconSize / 2],
					popupAnchor: [0, -iconSize / 3],
				};

				const icons = {
					opaque: [
						"img/full-outline.png",
						"img/full-outline-flipped.png",
					].map(iconUrl => L.icon({ iconUrl, ...iconSettings })),
					faded: [
						"img/full-outline-faded.png",
						"img/full-outline-flipped-faded.png",
					].map(iconUrl => L.icon({ iconUrl, ...iconSettings })),
				};

				for (let store of blahajData.data) {
					const currentIcons =
						store.quantity == 0 ? icons.faded : icons.opaque;

					const marker = L.marker([store.lat, store.lng], {
						icon: currentIcons[
							Math.floor(Math.random() * currentIcons.length)
						],
					});
					marker.bindPopup(
						store.name + ": <b>" + store.quantity + " blah√•j</b>",
					);
					marker.addTo(map);
				}
			})();
		</script>
	</body>
</html>
